<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì†Œë¹„ í‰ê°€ - ìŠ¤ì™€ì´í”„</title>
  <link rel="stylesheet" href="choose.css">
</head>
<body>
  <div class="page">
    <!-- í™ˆ ë²„íŠ¼ -->
    <button class="home-btn" type="button" onclick="location.href='index.html'">
      <img src="image/home.png" alt="í™ˆ ì•„ì´ì½˜" class="home-icon">
      <span class="home-label">í™ˆ í™”ë©´</span>
    </button>

    <!-- ì”¨ì•— ìºë¦­í„° -->
    <img src="image/seed.png" alt="ìºë¦­í„°" class="mascot">

    <!-- ë§í’ì„  -->
    <div class="question-wrap">
      <div class="speech-bubble">
        <span id="question-text" class="question-text"></span>
      </div>
    </div>

    <!-- í‰ê°€ ì¹´ë“œ ì˜ì—­ -->
    <div class="evaluate-area">
      <div class="evaluate-card" id="evaluate-card">
        <div class="evaluate-icon-wrap">
          <img id="expense-icon" src="" alt="ì•„ì´ì½˜" />
        </div>
        <div class="evaluate-title" id="expense-title"></div>
        <div class="evaluate-amount" id="expense-amount"></div>
      </div>
    </div>

    <!-- ì—„ì§€ ì•„ì´ì½˜ -->
    <div class="thumb-row">
      <div class="thumb thumb-left">
        <img src="image/tup.png" alt="ë§Œì¡±í•œ ì†Œë¹„" />
      </div>
      <div class="thumb thumb-right">
        <img src="image/tdown.png" alt="í›„íšŒí•˜ëŠ” ì†Œë¹„" />
      </div>
    </div>

    <!-- í˜ì´ì§€ ì¸ë””ì¼€ì´í„° -->
    <div class="dots" id="dots"></div>
  </div>

  <script>
    // ---------------------- 1. ë°ì´í„° ì •ì˜ ----------------------
    // swipe í™”ë©´ì—ì„œ ì“°ëŠ” ì†Œë¹„ ë‚´ì—­ (swipe.htmlê³¼ ë™ì¼í•œ êµ¬ì¡°ë¡œ ì‚¬ìš© ê°€ëŠ¥)
    const swipeExpenses = [
      { id: 0, title: "ë©”ê°€ì»¤í”¼",     amount: 3900,  icon: "image/mgc.png" },
      { id: 1, title: "ë©”ê°€ì»¤í”¼",     amount: 4500,  icon: "image/mgc.png" },
      { id: 2, title: "ë„·í”Œë¦­ìŠ¤",     amount: 13500, icon: "image/netflix.png" },
      { id: 3, title: "ë°°ë‹¬ì˜ ë¯¼ì¡±", amount: 22000, icon: "image/bmin.png" },
      { id: 4, title: "ë°°ë‹¬ì˜ ë¯¼ì¡±", amount: 12000, icon: "image/bmin.png" },
      { id: 5, title: "ë©”ê°€ì»¤í”¼",     amount: 2800,  icon: "image/mgc.png" },
      { id: 6, title: "ë„·í”Œë¦­ìŠ¤",     amount: 9500,  icon: "image/netflix.png" }
    ];

    // calendarBuyListì—ì„œ ë³´ì—¬ì£¼ëŠ” ì†Œë¹„ ë‚´ì—­ê³¼ "ê°™ì€ ê¸ˆì•¡"ìœ¼ë¡œ ë§ì¶˜ ë°ì´í„°
    // (idëŠ” calendarBuyListì˜ item.idì™€ ë™ì¼í•˜ê²Œ ì‚¬ìš©)
    const calendarExpenses = [
      { id: 1, title: "ë©”ê°€ì»¤í”¼",     amount: 3900,  icon: "image/mgc.png" },   // -3,900ì›
      { id: 2, title: "ë„·í”Œë¦­ìŠ¤",     amount: 11700, icon: "image/netflix.png" }, // -11,700ì›
      { id: 3, title: "ë°°ë‹¬ì˜ ë¯¼ì¡±", amount: 14000, icon: "image/bmin.png" },  // -14,000ì›
      { id: 4, title: "ë„·í”Œë¦­ìŠ¤",     amount: 11700, icon: "image/netflix.png" },
      { id: 5, title: "ë°°ë‹¬ì˜ ë¯¼ì¡±", amount: 14000, icon: "image/bmin.png" }
    ];

    const formatAmount = (n) =>
      "-" + n.toLocaleString("ko-KR", { maximumFractionDigits: 0 }) + "ì›";

    // ---------------------- 2. URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬ ----------------------
    const params = new URLSearchParams(window.location.search);

    // swipe.html â†’ choose.html?item=0&list=0,3,5
    const listParam = params.get("list");  // swipeì—ì„œ ì„ íƒëœ ì¸ë±ìŠ¤ë“¤

    // calendarBuyList.html â†’ choose.html?ids=1,3,5
    const idsParam  = params.get("ids");   // calendarì—ì„œ ì„ íƒëœ idë“¤

    function parseToIntArray(str) {
      if (!str) return [];
      return str
        .split(",")
        .map(v => parseInt(v, 10))
        .filter(v => !Number.isNaN(v));
    }

    // ğŸ’¡ ì‹¤ì œë¡œ í™”ë©´ì— ë³´ì—¬ ì¤„ í‰ê°€ ëŒ€ìƒ ë°°ì—´
    let evalExpenses = [];

    if (listParam) {
      // âœ… swipeì—ì„œ ì˜¨ ê²½ìš°: listë¥¼ swipeExpensesì˜ indexë¡œ ì‚¬ìš©
      const indices = parseToIntArray(listParam)
        .filter(idx => idx >= 0 && idx < swipeExpenses.length);
      evalExpenses = indices.map(idx => swipeExpenses[idx]);
    } else if (idsParam) {
      // âœ… calendarBuyListì—ì„œ ì˜¨ ê²½ìš°: idsë¥¼ calendarExpensesì˜ idë¡œ ì‚¬ìš©
      const ids = parseToIntArray(idsParam);
      evalExpenses = ids
        .map(id => calendarExpenses.find(e => e.id === id))
        .filter(Boolean);
    } else {
      // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê·¸ëƒ¥ swipe ì „ì²´ í‰ê°€ (fallback)
      evalExpenses = [...swipeExpenses];
    }

    // í˜¹ì‹œë¼ë„ evalExpensesê°€ ë¹„ì–´ ìˆìœ¼ë©´ ì•ˆì „í•˜ê²Œ swipe ì „ì²´ë¡œ
    if (evalExpenses.length === 0) {
      evalExpenses = [...swipeExpenses];
    }

    // ---------------------- 3. DOM ìš”ì†Œ ----------------------
    const cardEl     = document.getElementById("evaluate-card");
    const iconEl     = document.getElementById("expense-icon");
    const titleEl    = document.getElementById("expense-title");
    const amountEl   = document.getElementById("expense-amount");
    const dotsEl     = document.getElementById("dots");
    const thumbRowEl = document.querySelector(".thumb-row");
    const questionEl = document.getElementById("question-text");

    let currentPos = 0;
    const results = []; // { title, amount, decision }

    // ---------------------- 4. í˜ì´ì§€ ì¸ë””ì¼€ì´í„° ----------------------
    function renderDots() {
      dotsEl.innerHTML = "";
      evalExpenses.forEach((_, i) => {
        const dot = document.createElement("span");
        dot.className = "dot" + (i === currentPos ? " active" : "");
        dotsEl.appendChild(dot);
      });
    }

    // ---------------------- 5. í˜„ì¬ ì¹´ë“œ í‘œì‹œ ----------------------
    function showCurrentExpense() {
      const exp = evalExpenses[currentPos];

      iconEl.src = exp.icon;
      iconEl.alt = exp.title + " ì•„ì´ì½˜";
      titleEl.textContent = exp.title;
      amountEl.textContent = formatAmount(exp.amount);

      cardEl.style.transform = "translate(0, 0)";
      cardEl.style.opacity = "1";

      renderDots();
    }

    // ---------------------- 6. í‰ê°€ ì™„ë£Œ ì²˜ë¦¬ ----------------------
    function finishAll() {
      cardEl.classList.add("hidden");
      thumbRowEl.classList.add("hidden");
      dotsEl.classList.add("hidden");

      questionEl.textContent = "í‰ê°€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!";

      console.log("í‰ê°€ ê²°ê³¼:", results);

      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500);
    }

    // ---------------------- 7. ë‹¤ìŒ ì¹´ë“œë¡œ ì´ë™ ----------------------
    function goNext(decision) {
      const exp = evalExpenses[currentPos];
      results.push({
        title: exp.title,
        amount: exp.amount,
        decision
      });

      currentPos += 1;
      if (currentPos >= evalExpenses.length) {
        finishAll();
        return;
      }

      cardEl.classList.remove("transition");
      cardEl.style.transform = "translate(0, 0)";
      cardEl.style.opacity = "1";
      showCurrentExpense();
    }

    // ---------------------- 8. ìŠ¤ì™€ì´í”„ ì œìŠ¤ì²˜ ----------------------
    let dragging = false;
    let startX = 0;
    let startY = 0;
    let currentX = 0;
    let currentY = 0;
    let dragDirection = null; // 'horizontal' | 'vertical' | null

    const THRESHOLD_X = 80;
    const THRESHOLD_Y = 40;
    const MAX_DIST    = 160;

    function pointerDown(e) {
      dragging = true;
      dragDirection = null;
      cardEl.classList.remove("transition");

      const point = e.touches ? e.touches[0] : e;
      startX = point.clientX;
      startY = point.clientY;
      currentX = 0;
      currentY = 0;
    }

    function pointerMove(e) {
      if (!dragging) return;

      const point = e.touches ? e.touches[0] : e;
      const dx = point.clientX - startX;
      const dy = point.clientY - startY;

      if (!dragDirection) {
        const absX = Math.abs(dx);
        const absY = Math.abs(dy);
        if (absX > 6 || absY > 6) {
          if (absX > absY) {
            dragDirection = "horizontal";
          } else {
            if (dy > 0) {
              dragDirection = "vertical";
            } else {
              return; // ìœ„ë¡œëŠ” ë§‰ê¸°
            }
          }
        } else {
          return;
        }
      }

      let tx = 0;
      let ty = 0;
      let dist = 0;

      if (dragDirection === "horizontal") {
        tx = dx;
        ty = 0;
        dist = Math.min(MAX_DIST, Math.abs(tx));
      } else if (dragDirection === "vertical") {
        if (dy < 0) {
          ty = 0;
          dist = 0;
        } else {
          ty = dy;
          tx = 0;
          dist = Math.min(MAX_DIST, Math.abs(ty));
        }
      }

      const norm = dist / MAX_DIST;
      const opacity = 1 - norm * 0.6;

      cardEl.style.transform = `translate(${tx}px, ${ty}px)`;
      cardEl.style.opacity = String(opacity);

      currentX = tx;
      currentY = ty;

      e.preventDefault();
    }

    function pointerUp() {
      if (!dragging) return;
      dragging = false;
      cardEl.classList.add("transition");

      const absX = Math.abs(currentX);
      const absY = Math.abs(currentY);

      let decision = null;
      let offScreenTransform = "translate(0, 0)";

      if (dragDirection === "horizontal" && absX > THRESHOLD_X) {
        if (currentX < 0) {
          decision = "satisfied";
          offScreenTransform = "translate(-420px, 0)";
        } else {
          decision = "regret";
          offScreenTransform = "translate(420px, 0)";
        }
      } else if (
        dragDirection === "vertical" &&
        absY > THRESHOLD_Y &&
        currentY > 0
      ) {
        decision = "hold";
        offScreenTransform = "translate(0, 420px)";
      }

      if (!decision) {
        cardEl.style.transform = "translate(0, 0)";
        cardEl.style.opacity = "1";
        return;
      }

      cardEl.style.transform = offScreenTransform;
      cardEl.style.opacity = "0";

      setTimeout(() => {
        goNext(decision);
      }, 220);
    }

    cardEl.addEventListener("mousedown", pointerDown);
    cardEl.addEventListener("touchstart", pointerDown, { passive: false });

    window.addEventListener("mousemove", pointerMove);
    window.addEventListener("touchmove", pointerMove, { passive: false });

    window.addEventListener("mouseup", pointerUp);
    window.addEventListener("touchend", pointerUp);

    // ---------------------- 9. "ì´ ì†Œë¹„ëŠ” ì–´ë• ë‚˜ìš”?" íƒ€ì´í•‘ íš¨ê³¼ ----------------------
    const questionMessage = "ì´ ì†Œë¹„ëŠ” ì–´ë• ë‚˜ìš”?";
    let qIndex = 0;

    function typeQuestion() {
      if (qIndex <= questionMessage.length) {
        questionEl.textContent = questionMessage.slice(0, qIndex);
        qIndex++;
        setTimeout(typeQuestion, 60);
      }
    }

    // ì´ˆê¸° ë Œë”
    showCurrentExpense();
    typeQuestion();
  </script>
</body>
</html>
