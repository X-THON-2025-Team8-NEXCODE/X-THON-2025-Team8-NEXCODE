<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>가계부 캐릭터 앱</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    body {
      display: none;
    }
  </style>
</head>

<body>
  <div class="page">
    <!-- 헤더 -->
    <header class="app-header" style="margin-top: 48px;">
      <button class="icon-btn" aria-label="알림">
        <img src="image/alarm.png" alt="알림 아이콘" />
      </button>
      <button class="icon-btn" aria-label="마이페이지">
        <img src="image/my.png" alt="마이페이지 아이콘" />
      </button>
      <button class="icon-btn" aria-label="메뉴">
        <img src="image/more.png" alt="메뉴 아이콘" />
      </button>
    </header>

    <!-- 오늘의 지출 -->
    <section class="today-section">
      <div class="today-card">
        <div class="today-label-row">
          <span class="today-label">재호님의 오늘의 지출</span>
          <button class="refresh-btn" id="refresh-btn" aria-label="새로고침">
            <img src="image/f5.png" alt="새로고침 아이콘" class="refresh-icon" />
          </button>
        </div>
        <div class="today-amount-text" id="today-amount">
          0원
        </div>
      </div>
    </section>

    <!-- 캐릭터 레벨 & 진행률 링 -->
    <section class="mascot-section">
      <div class="progress-ring">
        <!-- SVG 진행률 원 -->
        <svg width="260" height="260">
          <defs>
            <!-- 진행률 색상 그라데이션 -->
            <linearGradient id="grad-progress" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" stop-color="#b7ffcd" />
              <stop offset="45%" stop-color="#8ef7b3" />
              <stop offset="100%" stop-color="#5de39e" />
            </linearGradient>
          </defs>

          <!-- 배경 링 -->
          <circle class="ring-bg" cx="130" cy="130" r="110" />

          <!-- 채워지는 링 -->
          <circle class="ring-progress" id="progress-circle" cx="130" cy="130" r="110" />
        </svg>

        <!-- 안쪽 동그라미 (씨앗 + 레벨) -->
        <div class="progress-inner">
          <img src="image/seed.png" alt="저금 캐릭터" class="mascot-img" />
          <div class="level-text" id="level-text">Lv. 1</div>
        </div>
      </div>
    </section>

    <!-- 가계부 / 후회도 / 소비 평가 -->
    <section class="actions-card">
      <div class="actions-row">
        <button class="action-item" onclick="location.href='calendar.html'">
          <img src="./image/calendar.png" alt="가계부 아이콘" />
          <span class="action-label">가계부</span>
        </button>

        <button class="action-item" onclick="location.href='regretRate.html'">
          <img src="./image/sad.png" alt="후회도 아이콘" />
          <span class="action-label">후회도</span>
        </button>

        <button class="action-item" id="review-button">
          <img src="./image/good.png" alt="소비 평가 아이콘" />
          <span class="action-label">소비 평가</span>
        </button>

        <button class="action-item" onclick="location.href='aiRecommend.html'">
          <img src="./image/ai.png" alt="AI 추천 아이콘" /> 
          <span class="action-label">AI 소비 추천</span>
        </button>
        </div>
    </section>

    <!-- 지출 내역 -->
    <section class="history-card">
      <div class="history-header">지출 내역</div>
      <div class="history-list" id="history-list"></div>
      <div class="history-more">더 보기</div>
    </section>
  </div>

  <script>
    const API_BASE_URL = 'https://x-thon.nexcode.kr:16010';

    const historyListEl = document.getElementById("history-list");
    const todayAmountEl = document.getElementById("today-amount");

    const formatCurrency = (n) =>
      n.toLocaleString("ko-KR", { maximumFractionDigits: 0 }) + "원";

    async function checkLoginStatus() {
      try {
        // credentials: 'include' 필수 (쿠키 전송)
        const response = await fetch(`${API_BASE_URL}/api/status`, {
          method: 'GET',
          credentials: 'include'
        });
        const data = await response.json();

        if (data.logged_in === true) {
          console.log("로그인 확인됨. User ID:", data.user_id);
          sessionStorage.setItem('user_id', data.user_id);
          document.body.style.display = 'block';
          init(data.user_id);
        } else {
          console.warn("비로그인 상태. 리다이렉트...");
          window.location.href = "login.html";
        }
      } catch (error) {
        console.error("서버 연결 실패:", error);
        window.location.href = "login.html";
      }
    }


    async function loadExpenses(userId) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/expenses`, {
          method: "POST",
          credentials: "include", //  쿠키 포함 필수
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            user_id: userId,
            date: new Date().toISOString().split('T')[0]
          })
        });
        const result = await response.json();

        // 렌더링 + 합계 계산
        let total = 0;

        const expensesList = result.data || [];

        historyListEl.innerHTML = ""; // 리스트 초기화

        if (expensesList.length === 0) {
          historyListEl.innerHTML = "<div style='padding:20px; text-align:center; color:#888;'>오늘의 지출 내역이 없습니다.</div>";
        }

        expensesList.forEach((item) => {
          total += item.price;

          const row = document.createElement("div");
          row.className = "history-item";

          let iconSrc = './image/bmin.png'

          row.innerHTML = `
	          <div class="history-left">
	            <div class="history-icon">
	              <img src="${iconSrc}" alt="${item.merchant} 아이콘" />
	            </div>
	            <div class="history-text">
	              <div class="history-title-row">
	                <span class="history-merchant">${item.merchant}</span>
	                <span class="history-tag">${item.category}</span>
	              </div>
	              <div class="history-sub">${item.price}</div>
	            </div>
	          </div>
	          <div class="history-right">
	            <span class="history-amount">-${formatCurrency(item.price)}</span>
	          </div>
	        `;

          historyListEl.appendChild(row);
        });
        return total
      } catch (error) {
        console.error("지출 내역을 불러오는 중 오류 발생:", error);
        return -1
      }
    }

    async function init(userId) {
      const totalAmount = await loadExpenses(userId);

      // 오늘의 지출 = 합계
      todayAmountEl.textContent = formatCurrency(totalAmount);

      // --------------------- 진행률 게이지 (원형 링) ---------------------
      const circle = document.getElementById("progress-circle");
      const radius = circle.r.baseVal.value;
      const circumference = 2 * Math.PI * radius;

      circle.style.strokeDasharray = `${circumference}`;
      circle.style.strokeDashoffset = `${circumference}`;

      // 예시: 오늘 예산 50,000원 기준으로 진행률 계산
      const DAILY_BUDGET = 50000;
      const progress = Math.max(
        0,
        Math.min(100, Math.round((totalAmount / DAILY_BUDGET) * 100))
      );

      function setProgress(percent) {
        const offset = circumference - (percent / 100) * circumference;
        circle.style.strokeDashoffset = offset;
      }

      // 살짝 딜레이 두고 애니메이션
      setTimeout(() => setProgress(progress), 300);
    }

    window.onload = checkLoginStatus;

    document
      .getElementById("refresh-btn")
      .addEventListener("click", () => location.reload());

    // 소비 평가 버튼 → swipe.html 이동
    document
      .getElementById("review-button")
      .addEventListener("click", () => {
        window.location.href = "swipe.html";
      });
  </script>
  <script src="characterManager.js"></script>
</body>

</html>